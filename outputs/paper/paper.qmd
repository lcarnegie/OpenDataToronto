---
title: "Exploring TTC Delays"
subtitle: "A Multimodal Analysis"
author: Luca Carnegie
thanks: "Code and data are available at: https://github.com/lcarnegie/OpenDataToronto. Thank you to Nescaf√© coffee, Rajan Maghera, Hannah Yu, and Sehar Bajwa for your love and support - could not have done it without you. No thanks go to Rohan in particular for not pointing out all the R he wanted us to learn that was in his textbook... sigh. I will try the appendix cocktails someday, though. :)"
date: today
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
toc: true
fig_caption: yes
number-sections: true
bibliography: references.bib

format: pdf
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(knitr)
library(janitor)
library(lubridate)
library(opendatatoronto)
library(tidyverse)
library(tidyr)
library(data.table)
library(dplyr)
library(kableExtra)
library(knitr)
library(gridExtra)
```

# Introduction

A key area of improvement in Canadian sustainability is in increasing the use of public transportation in big cities like Toronto. This makes sense, since cars account for about 80% of transportation emissions [@diaetal]. A major drawback preventing the widespread use of public transportation is the existence of delays within transit systems. These delays push citizens toward using less sustainable alternatives like private cars, leading to congestion on highways and consequent increased emissions. The lack of timely transit services have a demonstrated impact on traffic. One study by Anderson et al. estimated a whopping 47 percent increase in highway delay when transit service ceased completely in a big city such as Los Angeles [@anderson]. Learning from this example, it is imperative that policy makers understand and fix these delays to improve sustainability in Toronto.

The Toronto Transit Commission (TTC) has been Toronto's transit system since 1921, serving the city population with a variety of transportation methods, particularly subways, streetcars, and buses. The openly available data surrounding the delays of these various modes of transport offers the opportunity to investigate the root causes of these delays and prompt discussion as how to rectify them. Understanding the common causes of a delay, when a delay is typically caused and where it was caused gives the TTC more insight into how to deliver their services to the public more efficiently and effectively, setting an improved example of what an effective transit agency looks like.

Patterns of public transit delay time are found across various genres of transportation. First, the data source and analysis employed are covered in Section Two. Section Three then critically examines the data, delving deeper to arrive at various conclusions, as well as discussing implications and proposing new areas of exploration for this data. The difference between bus, streetcar, and subway delays is shown to be stark. This analysis highlights the need to focus on especially reducing bus delays on several key routes.  


# Data {#sec-data}
```{r data import}
#| message: false
#| echo: false
#| label: import data
#| tbl-cap: Sample of Cleaned Delay Data
#| fig-align: center

cleaned_transit_data <- read_csv(here::here("outputs/data/cleaned_dataset.csv"))

#make each Line a category, not an integer
cleaned_transit_data <- cleaned_transit_data |> mutate(Line = factor(Line))
```

To investigate transit delays in Toronto, data on bus [@busdata], subway [@subwaydata], and streetcar [@streetcardata] delay incidents for the year 2023 were downloaded using the OpenDataToronto R package [@odt] from the Toronto Open Data Catalogue. The data was then cleaned using R [@citeR], tidyverse [@tidyverse] and it's associated packages. After combining the datasets together, variables common between datasets and relevant to the analysis were selected, creating a dataset with 93,569 observations. For this analysis, the date (year, month, day), time, day of week, vehicle type, route/line, incident location, cause of delay, and time delay (in minutes) were considered. 

```{r sample table }
#| message: false
#| warning: false
#| echo: false
#| label: sample_table
#| tbl-cap: Sample of Cleaned Delay Data
#| fig-align: center



sample_table <- cleaned_transit_data |>
  rename(Vehicle = vehicle) |>
  rename(`Delay (Minutes)` = `Min Delay`) |>
  rename(Reason = Incident) |>
  rename(`Route/Line` = Line) |>
  arrange(Date) |>
  head(5)


#Scaling taken from: 
#https://stackoverflow.com/questions/56254631/table-way-too-wide-to-fit-in-markdown-generated-pdf

kable(sample_table, format = "markdown") |> kable_styling(latex_options = c("scale_down"))
```


## Incident Type {#subsec1-data}
```{r ggplot Common Delay Reasons}
#| message: false
#| echo: false
#| label: common-reasons-delay
#| tbl-cap: Most Common Reasons for Delay on TTC

#Bar chart of Reasons for delay vs. # of incidents

delay_dataset <- cleaned_transit_data

#Drop N/A incidents (they only apply to subways; subway dataset didn't indicate reasons with entries)
delay_dataset <- delay_dataset |> filter(Incident != "N/A")

delay_dataset |>
  count(Incident) |>
  ggplot(aes(x = n, y = reorder(Incident, n))) +
  geom_bar(stat="identity", fill="grey50") +
  labs(title="Bus and Streetcar Delay Reasons", x="Count", y="Incident Type") +
  theme(axis.text.x = element_text(angle = 30, hjust = 0.5, vjust = 0.5),
        panel.background = element_blank(),
        axis.line.y=element_line(color="black"),
        axis.ticks.y=element_blank(),
        panel.grid.major.x=element_line(color="grey80"),
        panel.grid.minor=element_blank(),
        plot.title.position = "plot",
        plot.title = element_text(hjust = 0.5))

```
Subways didn't have any reason for delay, yet have the most incidence of delay. 


## Line/Route {#subsec2-data}
```{r ggplot top 10 routes with longest avg. delay}
#| message: false
#| echo: false
#| label: lines-longest-delays
#| tbl-cap: Incidence of Delay, by Route/Line 

delay_by_line <- cleaned_transit_data

delay_by_line <- delay_by_line |> 
                 group_by(Line) |> 
                 summarise(avg_delay = mean(`Min Delay`, na.rm = TRUE), .groups = "drop") |> 
                 arrange(desc(avg_delay)) |> 
                 head(10)

# Plotting
ggplot(delay_by_line, aes(x = reorder(Line, desc(avg_delay)), y = avg_delay)) +
  geom_bar(stat = "identity") +
  labs(x = "Route/Line", y = "Average Delay (Minutes)", title = "Top 10 Routes with Longest Average Delay") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(hjust = 0.5))

```

```{r ggplot top 10 routes with most delay incidence}
#| message: false
#| echo: false
#| label: lines-most-delays
#| tbl-cap: Most Common Reasons for Delay on TTC

#Routes with highest delay incidence
delay_by_line <- cleaned_transit_data

delay_by_line <- delay_by_line |> 
                 group_by(Line) |> 
                 summarise(num_delays = n(), .groups = "drop") |> 
                 arrange(desc(num_delays)) |> 
                 head(10)
invisible(delay_by_line)

# Plotting
ggplot(delay_by_line, aes(x = reorder(Line, desc(num_delays)), y = num_delays)) +
  geom_bar(stat = "identity") +
  labs(x = "Route/Line", y = "Delay Incidence Count", title = "Top 10 Routes with Highest Delay Incidence") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(hjust = 0.5))



```

## Vehicle Type {#subsec3-data}
```{r ggplot transport with longest avg. delays}
#| message: false
#| echo: false
#| label: mode-longest-delays
#| tbl-cap: Most Common Reasons for Delay on TTC
#Bar graph of mode of transport with longest delays 

avg_time_delayed_vehicle <- cleaned_transit_data |> group_by(vehicle) |> summarise(avg_delay = mean(`Min Delay`, na.rm = TRUE), .groups = "drop")


avg_time_delayed_vehicle |>
  ggplot(mapping = aes(x = vehicle, y = avg_delay)) +
  geom_col() + 
  labs(title="Average Delay by Vehicle", x="Vehicle Type", y="Average Delay (mins)") +
  theme_minimal()
```
```{r ggplot transport with most incidence of delays }
#| message: false
#| echo: false
#| label: most-incidents-vehicle

#Bar graph of mode of transport with most incidence of delays 

most_delayed_vehicle <- cleaned_transit_data

num_incidents_vehicle <- most_delayed_vehicle |> group_by(vehicle) |> summarise(num_incidents = n(), .groups = "drop")

num_incidents_vehicle |>
  ggplot(mapping = aes(x = vehicle, y = num_incidents)) +
  geom_col() + 
  labs(title="Number of Incidents by Vehicle", x="Vehicle Type", y="Number of Incidents") +
  theme_minimal()

```

## Day of Week {#subsec4-data}
```{r ggplot Day of Week with Delay incidence}
#| message: false
#| echo: false
#| label: transport-delay-time
#| tbl-cap: Most Common Reasons for Delay on TTC
#Day of week with most incidence of delay

# Inspired by: https://stackoverflow.com/questions/34280140/order-bar-graph-in-order-in-this-case-as-per-days-of-week 

dow_data <- cleaned_transit_data

# Define the order of days
days_order <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")

# Convert 'Day' column to a factor with specific levels
dow_data$Day <- factor(dow_data$Day, levels = days_order)

# Now create the plot
num_incidents_vehicle <- dow_data |> arrange(Day) |> group_by(Day) |> summarise(num_incidents = n(), .groups = "drop")

num_incidents_vehicle |>
  ggplot(mapping = aes(x = Day, y = num_incidents)) +
  geom_col() +
  labs(title="Incidence of Delay by Day of Week", x="Day of Week", y="Incident Count") +
  theme_minimal()


```
```{r ggplot Day of Week with Avg. Delays}
#| message: false
#| echo: false
#| label: transport-delay-number
#| tbl-cap: Most Common Reasons for Delay on TTC
#| 

dow_data <- cleaned_transit_data

# Define the order of days
days_order <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")

# Convert 'Day' column to a factor with specific levels
dow_data$Day <- factor(dow_data$Day, levels = days_order)

#create tibble with avg delay time
avg_time_delayed_vehicle <- dow_data |> group_by(Day) |> summarise(avg_delay = mean(`Min Delay`, na.rm = TRUE), .groups = "drop")

#plot
avg_time_delayed_vehicle |>
  ggplot(mapping = aes(x = Day, y = avg_delay)) +
  geom_col() + 
  labs(title="Average Delay Time by Day of Week", x="Vehicle Type", y="Average Delay (mins)") +
  theme_minimal()
```


## Time of Year {#subsec5-data}
```{r ggplot avg delay change monthly}
#| message: false
#| echo: false
#| warning: false
#| label: monthly-delay-times
#| tbl-cap: Average Monthy Delay Times
#Line chart of how avg. delay time changes over the months

# create tibble with month col
month_dataset <- cleaned_transit_data |> mutate(month(Date)) |> rename(cleaned_transit_data$month, `month` = `month(Date)`)

#Calculate avg. delays 
avg_delay <- month_dataset |> group_by(month, vehicle) |> summarise(`Min Delay` = mean(`Min Delay`, na.rm = TRUE), .groups = "drop")


# convert month to factor (categorical data)
avg_delay$month <- factor(avg_delay$month, levels = 1:12, labels = month.abb[1:12])

# plot the graph
avg_delay |>
  ggplot(aes(x=month, y=`Min Delay`, color=vehicle, group=vehicle)) +
  geom_line() +
  labs(title="Average Monthly Delays by Vehicle", x="Month", y="Monthly Avg. Delay (minutes)") +
  scale_color_manual(values=c("blue","green", "red"), labels=c("Bus","Streetcar", "Subway")) +
  theme_minimal()
```















# Discussion {#sec-discussion}

## Results {#subsec1-discussion}

## Implications {#subsec2-discussion}

## New Areas of Exploration {#subsec3-discussion}

# Conclusion

# References

---
nocite: |
  @citeR, @ggplot, @odt, @janitor, @lubridate, @tidyverse, @dplyr, @ggplot, @testthat, @MartinWittmanLi, @diaetal, @anderson,
---

# Appendix: TTC Route Nomenclature
